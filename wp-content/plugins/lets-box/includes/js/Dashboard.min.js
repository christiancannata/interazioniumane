jQuery(document).ready(function(e){"use strict";e.widget("cp.LetsBoxDashboard",{options:{$container_totals:e("#letsbox-totals"),$container_events_chart:e("#letsbox-events-chart"),$container_top_downloads:e("#top-downloads"),$container_top_users:e("#top-users"),$container_latest_uploads:e("#latest-uploads"),$container_top_uploads:e("#top-uploads"),$container_full_log:e("#full-log")},chartjs:null,_create:function(){this._initiate()},_destroy:function(){return this._super()},_setOption:function(e,t){this._super(e,t)},_initiate:function(){var t=this;e("body").addClass("letsbox"),this._initChartDatePicker(),this._initChart(),this.options.$container_totals.one("inview",function(e,a){t.loadTotalsData(t.options.$container_totals,null,null)}),this.options.$container_events_chart.one("inview",function(e,a){t.loadChartData()}),this.options.$container_top_downloads.one("inview",function(e,a){t.loadTopDownloads()}),this.options.$container_top_users.one("inview",function(e,a){t.loadTopUsers()}),this.options.$container_latest_uploads.one("inview",function(e,a){t.loadLatestUploads()}),this.options.$container_top_uploads.one("inview",function(e,a){t.loadTopUploads()}),this.options.$container_full_log.one("inview",function(e,a){t.loadFullLog()}),this._initEvents()},_initEvents:function(){var t=this;e(t.element).on("click","a.open-entry-details",function(a){var n=e(this).data("entry-id");t.viewEntryDetails(n)}),e("body").on("click","#letsbox-modal-action a.open-entry-details",function(a){var n=e(this).data("entry-id");t.viewEntryDetails(n)}),e(t.element).on("click","a.open-user-details",function(a){var n=e(this).data("user-id");t.viewUserDetails(n)}),e("body").on("click","#letsbox-modal-action a.open-user-details",function(a){var n=e(this).data("user-id");t.viewUserDetails(n)}),e(t.element).on("click","#clear_statistics",function(e){t.clearStatistics()})},clearStatistics:function(){var t=this,a=e("#clear_statistics");a.addClass("disabled"),a.find(".wpcp-spinner").fadeIn(),e.ajax({method:"POST",url:t.options.ajax_url,data:{action:"letsbox-reset-statistics",_ajax_nonce:t.options.admin_nonce},complete:function(){a.removeClass("disabled"),a.find(".wpcp-spinner").fadeOut(),location.reload()},dataType:"json"})},_initChartDatePicker:function(){var e=this,t=e.element.find(".chart_datepicker_from"),a=e.element.find(".chart_datepicker_to");e.chart_datepicker_from=t.datepicker({altField:".chart_datepicker_from",autoSize:!0,dateFormat:"dd-mm-yy",changeMonth:!0}).on("change",function(){e.chart_datepicker_to.datepicker("option","minDate",moment(t.datepicker("getDate")).format("DD-MM-YYYY")),clearTimeout(e.updateChartTimer),e.updateChartTimer=setTimeout(function(){e.loadChartData(),e.fullLog.ajax.reload()},1e3)}),t.datepicker("setDate",moment().subtract(1,"months").toDate()),e.chart_datepicker_to=a.datepicker({altField:".chart_datepicker_to",autoSize:!0,dateFormat:"dd-mm-yy",changeMonth:!0,maxDate:"+0d"}).on("change",function(){e.chart_datepicker_from.datepicker("option","maxDate",moment(a.datepicker("getDate")).format("DD-MM-YYYY")),clearTimeout(e.updateChartTimer),e.updateChartTimer=setTimeout(function(){e.loadChartData(),e.fullLog.ajax.reload()},1e3)}),a.datepicker("setDate",moment().toDate())},loadChartData:function(){var t=this;t.options.$container_events_chart.prev().fadeIn(),t.chartjs.reset(),e.ajax({method:"POST",url:t.options.ajax_url,data:{action:"letsbox-event-stats",type:"activities",periodstart:moment(t.chart_datepicker_from.datepicker("getDate")).format("YYYY-MM-DD"),periodend:moment(t.chart_datepicker_to.datepicker("getDate")).format("YYYY-MM-DD"),_ajax_nonce:t.options.admin_nonce},success:function(e){t.chartjs.data=e,t.chartjs.update()},complete:function(e){t.options.$container_events_chart.prev().fadeOut()},dataType:"json"})},_initChart:function(){var e=this;e.chartjs=new Chart(e.options.$container_events_chart,{type:"line",options:{fill:!0,tension:.3,responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"},tooltip:{mode:"index",position:"nearest"}},scales:{x:{type:"time",beginAtZero:!1,time:{parser:"DD-MM-YYYY",unit:"day",tooltipFormat:"LL"},title:{display:!1}},y:{beginAtZero:!1,title:{display:!1}}}}})},loadTotalsData:function(t,a,n){var o=this;t.find(".letsbox-counter span").css({"background-color":"",color:""}),e.ajax({method:"POST",url:o.options.ajax_url,data:{action:"letsbox-event-stats",type:"totals",detail:a,id:n,_ajax_nonce:o.options.admin_nonce},success:function(e){o._setTotalsData(t,e)},complete:function(e){t.find(".loading").fadeOut()},dataType:"json"})},_setTotalsData:function(t,a){e.each(t.find(".letsbox-counter"),function(){var t=e(this).data("type");if(void 0===a[t])return e(this).find("span").append("0"),!0;var n=parseInt(a[t].total);e(this).find("span").css({"background-color":a[t].colors.normal,color:"white"}).append(n)})},loadTopDownloads:function(){var e=this;e.options.$container_top_downloads.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"entry_name"},{data:"total"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.entry_id+'"><img src="'+e+'" width="24px" height="24px"/></a>'}},{name:"entry_name",targets:1,className:"all",responsivePriority:1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.entry_id+'" title="'+a.parent_path+"/"+a.entry_name+'" class="open-entry-details" data-entry-id="'+a.entry_id+'">'+a.entry_name+"</a>"}},{name:"total",targets:2,width:"30px",className:"dt-right",render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:{url:e.options.ajax_url,data:{action:"letsbox-event-stats",type:"topdownloads",length:25,_ajax_nonce:e.options.admin_nonce}}})},loadTopUsers:function(){var e=this;e.options.$container_top_users.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"user_display_name"},{data:"user_name"},{data:"total"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'" ><img src="'+e+'" width="24px" height="24px"/></a>'}},{name:"user_display_name",targets:1,className:"all",responsivePriority:1,render:function(e,t,a,n){return"display"!==t?e:"0"===a.user_id?e:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"user_name",targets:2,className:"dt-left",render:function(e,t,a,n){return"display"!==t?e:"0"===a.user_id?e:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"total",targets:3,width:"30px",className:"dt-right",render:function(e,t,a,n){return e}}],order:[[3,"desc"]],processing:!0,serverSide:!0,ajax:{url:e.options.ajax_url,data:{action:"letsbox-event-stats",type:"topusers",length:25,_ajax_nonce:e.options.admin_nonce}}})},loadLatestUploads:function(){var e=this;e.options.$container_latest_uploads.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"entry_name"},{data:"datetime"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.entry_id+'"><img src="'+e+'" width="24px" height="24px"/></a>'}},{name:"entry_name",targets:1,className:"all",responsivePriority:1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.entry_id+'" title="'+a.parent_path+"/"+a.entry_name+'" class="open-entry-details" data-entry-id="'+a.entry_id+'">'+a.entry_name+"</a>"}},{name:"datetime",targets:2,width:"120px",className:"dt-right",render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:{url:e.options.ajax_url,data:{action:"letsbox-event-stats",type:"latestuploads",length:25,_ajax_nonce:e.options.admin_nonce}}})},loadTopUploads:function(){var e=this;e.options.$container_top_uploads.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"user_display_name"},{data:"user_name"},{data:"total"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'" ><img src="'+e+'" width="24px" height="24px"/></a>'}},{name:"user_display_name",targets:1,className:"all",responsivePriority:1,render:function(e,t,a,n){return"display"!==t?e:"0"===a.user_id?e:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"user_name",targets:2,className:"dt-left",render:function(e,t,a,n){return"display"!==t?e:"0"===a.user_id?e:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"total",targets:3,width:"30px",className:"dt-right",render:function(e,t,a,n){return e}}],order:[[3,"desc"]],processing:!0,serverSide:!0,ajax:{url:e.options.ajax_url,data:{action:"letsbox-event-stats",type:"topuploads",length:25,_ajax_nonce:e.options.admin_nonce}}})},loadFullLog:function(){var t=this;t.fullLog=t.options.$container_full_log.DataTable({dom:'fBrtip<"clear">',language:{loadingRecords:'<div class="loading"><div class="loader-beat"></div></div>',processing:'<div class="loading"><div class="loader-beat"></div></div>'},autoWidth:!0,deferRender:!0,scrollY:500,scroller:!0,scrollCollapse:!0,pageLength:50,searchDelay:600,buttons:[{text:'<i class="eva eva-download-outline eva-lg"></i>',className:"simple-button blue",action:function(a,n,o,s){e.ajax({url:t.options.ajax_url,data:{action:"letsbox-event-stats",type:"full-log",export:!0,periodstart:moment(t.chart_datepicker_from.datepicker("getDate")).format("YYYY-MM-DD"),periodend:moment(t.chart_datepicker_to.datepicker("getDate")).format("YYYY-MM-DD"),_ajax_nonce:t.options.admin_nonce},success:function(e,t,a){var n=new Blob([e],{type:"text/csv;charset=utf-8;"}),o=window.URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.setAttribute("download","data.csv"),s.click()}})}},{extend:"copy",text:'<i class="eva eva-copy-outline eva-lg"></i>',className:"simple-button blue"},{extend:"print",text:'<i class="eva eva-printer-outline eva-lg"></i>',className:"simple-button blue",title:""},{extend:"colvis",text:'<i class="eva eva-funnel-outline eva-lg"></i>',className:"simple-button blue",background:!1,columns:[1,2,3,4,5,6,7,8]}],columns:[{data:"icon"},{data:"description"},{data:"datetime"},{data:"type"},{data:"user"},{data:"entry_name"},{data:"parent_path"},{data:"location"},{data:"extra"}],columnDefs:[{name:"icon",targets:0,orderable:!1,width:"24px",className:"dt-left all",searchable:!1,render:function(e,t,a,n){return"display"!==t?e:"<i class='eva "+e+" eva-lg'></i>"}},{name:"description",targets:1,className:"dt-left",searchable:!1,render:function(e,t,a,n){return e}},{name:"datetime",targets:2,width:"150px",className:"dt-left all",render:function(e,t,a,n){return e}},{name:"type",targets:3,className:"all",visible:!1,render:function(e,t,a,n){return e}},{name:"user",targets:4,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"entry_name",targets:5,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"parent_path",targets:6,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"location",targets:7,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:""===e?"":'<a href="'+a.location_full+'" target="_blank"><i class="eva eva-external-link-outline"></i> '+e+"</a>"}},{name:"extra",targets:8,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:{url:t.options.ajax_url,data:function(e){e.action="letsbox-event-stats",e.type="full-log",e.periodstart=moment(t.chart_datepicker_from.datepicker("getDate")).format("YYYY-MM-DD"),e.periodend=moment(t.chart_datepicker_to.datepicker("getDate")).format("YYYY-MM-DD"),e._ajax_nonce=t.options.admin_nonce}}})},loadDetailedLog:function(t,a,n){var o=this;t.DataTable({dom:'fBrtip<"clear">',language:{loadingRecords:'<div class="loading"><div class="loader-beat"></div></div>',processing:'<div class="loading"><div class="loader-beat"></div></div>'},autoWidth:!0,deferRender:!0,scrollY:300,scroller:!0,pageLength:50,searchDelay:600,responsive:!0,buttons:[{text:'<i class="eva eva-download-outline eva-lg"></i>',className:"simple-button blue",action:function(t,s,i,r){e.ajax({url:o.options.ajax_url,data:{action:"letsbox-event-stats",type:"full-log",detail:a,id:n,export:!0,_ajax_nonce:o.options.admin_nonce},success:function(e,t,a){var n=new Blob([e],{type:"text/csv;charset=utf-8;"}),o=window.URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.setAttribute("download","data.csv"),s.click()}})}},{extend:"copy",text:'<i class="eva eva-copy-outline eva-lg"></i>',className:"simple-button blue"},{extend:"print",text:'<i class="eva eva-printer-outline eva-lg"></i>',className:"simple-button blue",title:""},{extend:"colvis",text:'<i class="eva eva-funnel-outline eva-lg"></i>',className:"simple-button blue",background:!1,columns:[1,2,3,4,5,6,7,8]}],columns:[{data:"icon"},{data:"description"},{data:"datetime"},{data:"type"},{data:"user"},{data:"entry_name"},{data:"parent_path"},{data:"location"},{data:"extra"}],columnDefs:[{name:"icon",targets:0,orderable:!1,width:"24px",className:"dt-left all",searchable:!1,render:function(e,t,a,n){return"display"!==t?e:"<i class='eva "+e+" eva-lg'></i>"}},{name:"description",targets:1,className:"dt-left",searchable:!1,render:function(e,t,a,n){return e}},{name:"datetime",targets:2,width:"150px",className:"dt-left all",render:function(e,t,a,n){return e}},{name:"type",targets:3,className:"all",visible:!1,render:function(e,t,a,n){return e}},{name:"user",targets:4,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"entry_name",targets:5,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"parent_path",targets:6,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"location",targets:7,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:""===e?"":'<a href="'+a.location_full+'" target="_blank"><i class="eva eva-external-link-outline"></i>'+e+"</a>"}},{name:"extra",targets:8,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:o.options.ajax_url+"?action=letsbox-event-stats&type=full-log&detail="+a+"&id="+n+"&_ajax_nonce="+o.options.admin_nonce})},viewEntryDetails:function(e){var t=this;t.openModal("entry",e)},viewUserDetails:function(e){var t=this;t.openModal("user",e)},openModal:function(t,a){var n=this;e("#letsbox-modal-action").remove();var o="";o+='<button class="simple-button blue letsbox-modal-cancel-btn secondary" data-action="cancel" type="button" onclick="modal_action.close();" title="'+n.options.str_close_title+'" >'+n.options.str_close_title+"</button>";var s=e('<a tabindex="0" class="close-button" title="'+n.options.str_close_title+'" onclick="modal_action.close();"><i class="eva eva-close eva-lg" aria-hidden="true"></i></a></div>'),i=e('<div class="letsbox letsbox-modal-body" tabindex="0" style="display:none"></div>'),r=e('<div class="letsbox-modal-footer" style="display:none"><div class="letsbox-modal-buttons">'+o+"</div></div>"),l=e('<div id="letsbox-modal-action" class="LetsBox letsbox-modal letsbox-modal80 '+n.options.content_skin+'"><div class="modal-dialog"><div id="LetsBox" class="modal-content"><div class="loading"><div class="loader-beat"></div></div></div></div></div>');e("body").append(l);var d=e(".event-details-template").clone().appendTo(i).show();switch(e("#letsbox-modal-action .modal-content").append(s,i,r),t){case"user":var c=e(".modal-content  .event-details-user-template").show();break;case"entry":c=e(".modal-content  .event-details-entry-template").show()}var u=e(".modal-content .event-details-totals-template");u.find("span").html('<div class="loading"><div class="loader-beat"></div></div>'),n.loadTotalsData(u,t,a),e.ajax({type:"POST",url:n.options.ajax_url,data:{action:"letsbox-event-stats",type:"get-detail",detail:t,id:a,_ajax_nonce:n.options.admin_nonce},success:function(a){switch(t){case"user":d.find(".event-details-name").text(a.user.user_name),c.find(".event-details-email").text(a.user.user_email),c.find(".event-details-roles").text(a.user.user_roles),c.find(".event-details-entry-img").css("background-image","url("+a.user.avatar+")"),c.find(".event-visit-profile").attr("href",a.user.user_link);break;case"entry":d.find(".event-details-name").text(a.entry.entry_name),c.find(".event-details-description").text(a.entry.entry_description),c.find(".event-details-entry-img").css("background-image","url("+a.entry.entry_thumbnails+")"),!1===a.entry.entry_link?c.find(".event-download-entry").fadeOut():c.find(".event-download-entry").attr("href",a.entry.entry_link+"&_ajax_nonce="+n.options.admin_nonce)}e(".letsbox-modal-body").fadeIn(),e(".letsbox-modal-footer").fadeIn(),e(".modal-content .loading:first").fadeOut()},complete:function(){c.find(".loading").fadeOut()},dataType:"json"}),n.loadDetailedLog(e("#letsbox-modal-action .modal-content table"),t,a);var p=new RModal(document.getElementById("letsbox-modal-action"),{bodyClass:"rmodal-open",dialogOpenClass:"animated slideInDown",dialogCloseClass:"animated slideOutUp",escapeClose:!0});document.addEventListener("keydown",function(e){p.keydown(e)},!1),p.open(),window.modal_action=p}}),e(".LetsBoxDashboard").LetsBoxDashboard(LetsBox_Dashboard_vars)});